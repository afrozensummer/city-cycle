<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
    <script src="http://d3js.org/d3.v3.js" charset="utf-8"></script>
    <script src="libs/jquery.min.js" charset="utf-8"></script>
    <script src="js/slider.js"></script>
    <link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.8/mapbox.css' rel='stylesheet' />
    <script src="http://cdn.leafletjs.com/leaflet-0.7/leaflet.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.8/mapbox.js'></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    
    <link href='http://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <style type="text/css">

html, body {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
}

.bikes, .stations, .bikes svg, .stations svg {
  position: absolute;
}

.bikes, .stations svg {
  width: 60px;
  height: 20px;
  padding-right: 100px;
  font: 10px sans-serif;
}

.stations circle {
  fill: steelblue;
  opacity: 0.5;
/*  stroke: black;
  stroke-width: .8px;*/
}

.bikes circle {
  fill: #000;
  z-index: 1;
  opacity: 1;
} 

    </style>
  </head>
  <body class = "viscontainer"> 
    <div class = "header">
      CitiBike Visualization
    </div>
    <div>
      Lorem ipsum dolor sit amet, consectetur adipisicing elit. Voluptatem aspernatur facilis ipsum, beatae! Quasi amet ratione perspiciatis velit, excepturi nisi. Magni repellat amet illum ducimus cum. Saepe harum repellendus perspiciatis. <br><br>
    </div>
    <div id="time"> </div>
    <div id="slider"></div>
    <div id="map"></div> 
    <script type="text/javascript">
//Data
var bike_data;
var station_data;

queue()
  .defer(d3.json, "data/stations.json") 
  .defer(d3.csv, "data/december2014.csv")
    .await(function(error, stations, bikes) { 
        //error handling
        station_data = stations;
        bike_data = bikes;
        data_loaded();

  });

function data_loaded() {
  console.log(bike_data);

  // Date Formating 
  var formatDate = d3.time.format("%a, %b %e, %H:%M");
  document.getElementById("time").innerHTML = "Current Time: " + formatDate(new Date("2014-12-01 0:00:00"));

  // Create a date range slider
  var MyEventHandler = new Object();
  var slider = new Slider(d3.select("#slider"), [], MyEventHandler);

  // Handle the event for the slider
  $(MyEventHandler).bind("selectionChanged", function(event, value) {
    document.getElementById("time").innerHTML = "Current Time: " + formatDate(value.time);

  });

  // Build the map
  L.mapbox.accessToken = 'pk.eyJ1IjoiY2l0eWN5Y2xlIiwiYSI6IjZ3MXNtRW8ifQ.lmAxO5RTphn4Jo-QV63Vpg';
  var layer = L.mapbox.tileLayer('citycycle.lnkh0jpk');
  var map = L.map('map')
      .addLayer(layer)
      .setView([40.72332345541449, -73.99], 12);

  var svg = d3.select(map.getPanes().overlayPane).append("svg");
  console.log(svg);
  var g = svg.append("g").attr("class", "leaflet-zoom-hide");

  var stationsList = station_data["stationBeanList"];
  //var transform = d3.geo.transform({ point : projectPoint});

  var stations = g.selectAll("circle")
            .data(stationsList)
            .enter()
            .append("circle")
            .attr("r", 3)
            .attr("class", "stations");

  function applyLatLngToLayer(d) {
    var y = d.latitude;
    var x = d.longitude;
    console.log(map.latLngToLayerPoint(new L.LatLng(y, x)));
    return map.latLngToLayerPoint(new L.LatLng(y, x))
  }

  function reset() {
    
    stations.attr("transform",
                  function(d) {
                      return "translate(" +
                          applyLatLngToLayer(d).x + "," +
                          applyLatLngToLayer(d).y + ")";
                  });
  }

  reset();
  map.on("viewreset", reset);
    

  //transforms to svg path codes
 /* var d3path = d3.geo.path().projection(transform);

  var feature = g.selectAll("path")
                   .data(stationsList)
                   .enter()
                   .append("path");
           map.on("viewreset", reset);
           reset();
          // Reposition the SVG to cover the features.
  function reset() {
      var bounds = path.bounds(stationsList),
              topLeft = bounds[0],
              bottomRight = bounds[1];
      svg.attr("width", bottomRight[0] - topLeft[0])
              .attr("height", bottomRight[1] - topLeft[1])
              .style("left", topLeft[0] + "px")
              .style("top", topLeft[1] + "px");
      g.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
      //apply a class with the 'handle' value from the geojson file
      feature.attr("class", function (d) {
          return "code " + d.handle;
      });
      feature.attr("d", path);
    }

  function projectPoint(x, y) {
      console.log(x +":"+y);
      var point = map.latLngToLayerPoint(new L.LatLng(y, x));
      this.stream.point(point.x, point.y);
  }

  var stations = g.selectAll(".station")
          .data(stationsList)
          .enter()
          .append("circle", ".stations")
          .attr("r", 5)
          .style("fill", "steelblue")
          .style("opacity", "0.5");

  reset();
  transition();

    //console.log(data["stationBeanList"]);
    // var overlay = new google.maps.OverlayView();
    // var stationsList = data["stationBeanList"];

    // // Add the container when the overlay is added to the map.
    // overlay.onAdd = function() {
    //   var layer = d3.select(this.getPanes().overlayLayer).append("div")
    //       .attr("class", "stations");

    //   // Draw each marker as a separate SVG element.
    //   // We could use a single SVG, but what size would it have?
    //   overlay.draw = function() {
    //     var projection = this.getProjection(),
    //         padding = 10;

    //     var marker = layer.selectAll("svg")
    //         //.data(d3.entries(data))
    //         .data(d3.entries(stationsList))
    //         .each(transform) // update existing markers
    //       .enter().append("svg:svg")
    //         .each(transform)
    //         .attr("class", "marker");

    //     // Add a circle.
    //     marker.append("svg:circle")
    //         .attr("r", 3)
    //         .attr("cx", padding)
    //         .attr("cy", padding);

    //     function transform(d) {
    //       d = new google.maps.LatLng(d.value.latitude, d.value.longitude);
    //       d = projection.fromLatLngToDivPixel(d);
       
    //       // console.log(d);
    //       return d3.select(this)
    //           .style("left", (d.x - padding) + "px")
    //           .style("top", (d.y - padding) + "px");
    //     }
    //   };
    // };

    // // Bind our overlay to the map…
    // overlay.setMap(map);
  };

  function applyLatLngToLayer(d) {
    var y = d.geometry.coordinates[1]
    var x = d.geometry.coordinates[0]
    return map.latLngToLayerPoint(new L.LatLng(y, x))
  

  // we should get rid of landmarks on map
/*
    d3.csv("data/december2014.csv", function(err, data) {
      var overlaybikes = new google.maps.OverlayView();
      var minidata = [];
      var i = 0;
      while (data[i].starttime < "12/1/2014 11:59:59") {
        minidata.push(data[i]);
        i++;
      }
      //console.log(minidata)
      // Add the container when the overlay is added to the map.
      overlaybikes.onAdd = function() {
        var layer = d3.select(this.getPanes().overlayLayer).append("div")
            .attr("class", "bikes");

        // Draw each marker as a separate SVG element.
        // We could use a single SVG, but what size would it have?
        overlaybikes.draw = function() {
          var projection = this.getProjection(),
              padding = 10;
          //console.log(minidata[0])

          var marker = layer.selectAll("svg")
              .data(d3.entries(minidata))
              .each(transform) // update existing markers
            .enter().append("svg:svg")
              .each(transform)
              .attr("class", "marker");

          // Add a circle.
          marker.append("svg:circle")
              .attr("r", 1.5)
              .attr("cx", padding)
              .attr("cy", padding);

          function transform(d) {
            //console.log(d.value["start station longitude"])
            d = new google.maps.LatLng(d.value["start station latitude"], d.value["start station longitude"]);
            d = projection.fromLatLngToDivPixel(d);
          
            //console.log(d);
            return d3.select(this)
                .style("left", (d.x - padding) + "px")
                .style("top", (d.y - padding) + "px");
          }

        };
      };

      // Bind our overlay to the map…
      overlaybikes.setMap(map);

      //trying to update...

    });*/
}

    </script>

  </body>
</html>
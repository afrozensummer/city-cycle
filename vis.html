<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
    <script src="libs/d3/d3.min.js" charset="utf-8"></script>
    <script src="libs/jquery.min.js" charset="utf-8"></script>
    <script src="js/slider.js"></script>
    <link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.8/mapbox.css' rel='stylesheet' />
    <script src="http://cdn.leafletjs.com/leaflet-0.7/leaflet.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.8/mapbox.js'></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    
    <link href='http://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <style type="text/css">

html, body {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
}

.bikes, .stations, .bikes svg, .stations svg {
  position: absolute;
}

.bikes, .stations svg {
  width: 60px;
  height: 20px;
  padding-right: 100px;
  font: 10px sans-serif;
}

.stations circle {
  fill: steelblue;
  opacity: 0.5;
/*  stroke: black;
  stroke-width: .8px;*/
}

.bikes circle {
  fill: #000;
  z-index: 1;
  opacity: 1;
} 

    </style>
  </head>
  <body class = "viscontainer"> 
    <div class = "header">
      CitiBike Visualization
    </div>
    <div>
      Lorem ipsum dolor sit amet, consectetur adipisicing elit. Voluptatem aspernatur facilis ipsum, beatae! Quasi amet ratione perspiciatis velit, excepturi nisi. Magni repellat amet illum ducimus cum. Saepe harum repellendus perspiciatis. <br><br>
    </div>
    <div id="time"> </div>
    <div id="slider"></div>
    <div id="map"></div> 
    <script type="text/javascript">
//Data
var bike_data;
var station_data;

queue()
  .defer(d3.json, "data/stations.json") 
  .defer(d3.csv, "data/december2014.csv")
    .await(function(error, stations, bikes) { 
        //error handling
        station_data = stations;
        bike_data = bikes;
        data_loaded();

  });

function data_loaded() {
  console.log(bike_data);

  // Date Formating 
  var formatDate = d3.time.format("%a, %b %e, %H:%M");
  document.getElementById("time").innerHTML = "Current Time: " + formatDate(new Date("2014-12-01 0:00:00"));

  // Create a date range slider
  var MyEventHandler = new Object();
  var slider = new Slider(d3.select("#slider"), [], MyEventHandler);

  $(MyEventHandler).bind("selectionChanged", function(event, value) {
    document.getElementById("time").innerHTML = "Current Time: " + formatDate(value.time);

  });

  L.mapbox.accessToken = 'pk.eyJ1IjoiY2l0eWN5Y2xlIiwiYSI6IjZ3MXNtRW8ifQ.lmAxO5RTphn4Jo-QV63Vpg';
  // Create a map in the div #map
  L.mapbox.map('map', 'citycycle.lnkh0jpk');



  d3.json("data/stations.json", function(err, data) {
    //console.log(data["stationBeanList"]);
    var overlay = new google.maps.OverlayView();
    var stationsList = data["stationBeanList"];

    // Add the container when the overlay is added to the map.
    overlay.onAdd = function() {
      var layer = d3.select(this.getPanes().overlayLayer).append("div")
          .attr("class", "stations");

      // Draw each marker as a separate SVG element.
      // We could use a single SVG, but what size would it have?
      overlay.draw = function() {
        var projection = this.getProjection(),
            padding = 10;

        var marker = layer.selectAll("svg")
            //.data(d3.entries(data))
            .data(d3.entries(stationsList))
            .each(transform) // update existing markers
          .enter().append("svg:svg")
            .each(transform)
            .attr("class", "marker");

        // Add a circle.
        marker.append("svg:circle")
            .attr("r", 3)
            .attr("cx", padding)
            .attr("cy", padding);

        function transform(d) {
          d = new google.maps.LatLng(d.value.latitude, d.value.longitude);
          d = projection.fromLatLngToDivPixel(d);
       
          // console.log(d);
          return d3.select(this)
              .style("left", (d.x - padding) + "px")
              .style("top", (d.y - padding) + "px");
        }
      };
    };

    // Bind our overlay to the map…
    overlay.setMap(map);
  });

  // we should get rid of landmarks on map

    d3.csv("data/december2014.csv", function(err, data) {
      var overlaybikes = new google.maps.OverlayView();
      var minidata = [];
      var i = 0;
      while (data[i].starttime < "12/1/2014 11:59:59") {
        minidata.push(data[i]);
        i++;
      }
      //console.log(minidata)
      // Add the container when the overlay is added to the map.
      overlaybikes.onAdd = function() {
        var layer = d3.select(this.getPanes().overlayLayer).append("div")
            .attr("class", "bikes");

        // Draw each marker as a separate SVG element.
        // We could use a single SVG, but what size would it have?
        overlaybikes.draw = function() {
          var projection = this.getProjection(),
              padding = 10;
          //console.log(minidata[0])

          var marker = layer.selectAll("svg")
              .data(d3.entries(minidata))
              .each(transform) // update existing markers
            .enter().append("svg:svg")
              .each(transform)
              .attr("class", "marker");

          // Add a circle.
          marker.append("svg:circle")
              .attr("r", 1.5)
              .attr("cx", padding)
              .attr("cy", padding);

          function transform(d) {
            //console.log(d.value["start station longitude"])
            d = new google.maps.LatLng(d.value["start station latitude"], d.value["start station longitude"]);
            d = projection.fromLatLngToDivPixel(d);
          
            //console.log(d);
            return d3.select(this)
                .style("left", (d.x - padding) + "px")
                .style("top", (d.y - padding) + "px");
          }

        };
      };

      // Bind our overlay to the map…
      overlaybikes.setMap(map);

      //trying to update...

    });
}

    </script>

  </body>
</html>
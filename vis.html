<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
    <script src="http://d3js.org/d3.v3.js" charset="utf-8"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6/jquery.min.js"></script>
    
    <link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.8/mapbox.css' rel='stylesheet' />
    <script src="http://cdn.leafletjs.com/leaflet-0.7/leaflet.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.8/mapbox.js'></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    
    <link href='http://fonts.googleapis.com/css?family=Raleway|Poiret+One' rel='stylesheet' type='text/css'>
    
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/themes/base/jquery-ui.css" />
    <script src = "js/averageDayVis.js"></script>
    <script src = "js/aggregateVis.js"></script>
    <script src="js/bikelinechart.js"></script>
    
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <style type="text/css">

html, body {
  width: 100%;
  height: 100%;
  background: url(../img/skyline.jpg) no-repeat center center fixed;
  background-size: cover;
  margin: 0;
  padding: 0;
}


    </style>
  </head>
  <body class = "viscontainer"> 
    <div class = "header">
      CitiBike Visualization
    </div>
    <div class = "vis_text">
      This is our CS171 Project: CityCycle.
      We'll include our story on the first page so whatever bleh. Lorem ipsum dolor sit amet, consectetur adipisicing elit. Quis temporibus dignissimos accusamus quia, praesentium nam enim deleniti odit laborum iste doloremque repudiandae, non provident. Ea impedit quisquam, repudiandae vel quia. <br><br>
    </div>

    <div id = "controls">
    <input type="image" src="img/reset.png" name="reset" class="button" id = "reset" />
    <input type="image" src="img/play.png" name="play" class="button" id = "play" />
    <input type="image" src="img/pause.png" name="pause" class="button" id = "pause" />
    <!--<input type="range" data-highlight="true" name="minutes" min="0" max="0" step="1" value="0" class="slider" id="slider-time"; >-->
    
    
  </div>
  <div id = "bike_categorize"> 
        Categorize By:
        <label><input type="radio" name="filter" value="none" checked> None </label>
        <label><input type="radio" name="filter" value="gender"> Gender </label>  
        <label><input type="radio" name="filter" value="subscription"> Subscription </label>
        <label><input type="radio" name="filter" value="age"> Age </label>
        <button  class = "buttonactive" type="button" value="july_4"> July 4</button>
        <button class = "day" type="button" value="dec_1">Dec 1</button>
        <button class = "day" type="button">Other Day</button>
        <button class = "day" type="button">Other Day</button>
    </div>
    <div id="bikeline"></div>
  <div id="slider"></div> <br>
      
    <div id = "description_container">
      <div id = "time"></div>
      <br>
      <div id = "temp"></div>  
      <div id = "weathericon"><img src="/img/sun.png" alt=""></div>
    </div><!-- <div id="map_cover"></div> -->
      
      <div id="legend"></div> 
      <div id="map"></div>
      <div id="barchart"></div>
      <div id="aggregate_chart"></div>

      

     
    <script type="text/javascript">

// Variables
var current_day = "july_4";
var dec1_bikes;
var july4_bikes;
var barchart_data;
var station_data;
var starting_time = new Date("2014-07-04 00:00:00"); //start with july
var ending_time = new Date("2014-07-05 00:00:00");
var current_time = starting_time;
var filter = "none";
var filters = {
    none: function(d) {return "#000"},
    gender: function(d) { 
      if(d.gender == 1) return "#0000ff";
      if(d.gender == 2) return "#FF0000";
      return "#8A2BE2";
    },
    subscription: function(d) { 
      if(d.usertype == "Customer") return "#0080ff";
      return "#ffa500";
    },
    age: function(d) { 
      var age = 2014 - d["birth year"];
      if(age < 20) return "#ADD8E6";
      if(age >= 20 && age < 50) return "#2072BC";
      if(age > 50) return "#00264A";
      return "gray"; //no age indicated
    }
  };

queue()
  .defer(d3.json, "data/stations.json") 
  //.defer(d3.csv, "data/december2014.csv")
  .defer(d3.csv, "data/july4.csv")
  .defer(d3.csv, "data/july4weather.csv")
  .defer(d3.csv, "data/december1.csv") 
  .defer(d3.csv, "data/december1stweatherdata.csv")
    .await(function(error, stations, july4_b, july4_w, dec1_b, decemberfirst) { 
        // error handling
        station_data = stations;
        july4_bikes = july4_b;
        july4_weather = july4_w;
        dec1_bikes = dec1_b;
        december_first_data = decemberfirst;
        data_loaded();


  });

function data_loaded() {

  var formatHour = d3.time.format("%H");
  var formatMinute = d3.time.format("%M");
  var formatDate = d3.time.format("%a, %b %e");
  //var formatDay = d3.time.format("%");
  
  var stationsList = station_data["stationBeanList"];

  bike_data = july4_bikes; //start with december
  weather_data = july4_weather;

  function format_hour_bar (bike_data) {

    var day_array = d3.range(24).map(function () { return 0; });

    var index = 0;
    var lasthour = "00";
    var date = new Date (bike_data[1000].starttime);
    var true_date = formatDate(date);
    console.log(true_date);

    bike_data.forEach(function(i){
      var hour = new Date (i.starttime);
      var now = formatHour(hour);
      var this_date = formatDate(hour);

      if (this_date == true_date){
        if (now != lasthour) {
          index +=1;
          lasthour = now;
        }
        day_array[index] += 1;
      }   
    })
    return day_array
  } 

  function format_hour_bar_gender (bike_data) {

    var female_array = d3.range(24).map(function () { return 0; });
    var male_array = d3.range(24).map(function () { return 0; });

    var index = 0;
    var lasthour = "00";
    var date = new Date (bike_data[1000].starttime);
    var true_date = formatDate(date);
    //console.log(true_date);
    console.log(bike_data);

    bike_data.forEach(function(i){
      var hour = new Date (i.starttime);
      var now = formatHour(hour);
      var this_date = formatDate(hour);

      if (this_date == true_date){
        if (now != lasthour) {
          index +=1;
          lasthour = now;
        } 
        if (i.gender == 1){
          male_array[index] += 1;
        } if (i.gender == 2){
          female_array[index] +=1;
        }
      }   
    })
    return [male_array, female_array]
  }

  console.log(format_hour_bar_gender(july4_bikes));



  function format_aggregate_bar (bike_data) {

    var minute_aggregate = d3.range(1440).map(function () { return 0; });
    var index = 0;
    var date = new Date (bike_data[1000].starttime);
    var true_date = formatDate(date);

    bike_data.forEach(function(d){

      var time = new Date (d.starttime);
      if (formatDate(time) == true_date){
        var new_index = (60 * parseInt(formatHour(time))) + parseInt(formatMinute(time));
        if (new_index == index){
          minute_aggregate[index] += 1;
        } else {
          index +=1;
          minute_aggregate[index] = minute_aggregate[index - 1] + 1; 
        }
      }
    })
    return minute_aggregate;
  }

  gender_barchart_data = [{"date":"July 4", "gender": "male", "bikers": format_hour_bar_gender(july4_bikes)[0]}, {"date":"July 4", "gender": "female", "bikers": format_hour_bar_gender(july4_bikes)[1]},{"date": "December 1", "gender": "male", "bikers": format_hour_bar_gender(dec1_bikes)[0]},{"date": "December 1", "gender": "female", "bikers": format_hour_bar_gender(dec1_bikes)[1]}];

  console.log(gender_barchart_data);

  barchart_data = [{"date":"July 4", "bikers": format_hour_bar(july4_bikes)}, {"date": "December 1", "bikers": format_hour_bar(dec1_bikes)}];

  aggregate_info = [{"date":"July 4", "bikers": format_aggregate_bar(july4_bikes)}, {"date": "December 1", "bikers": format_aggregate_bar(dec1_bikes)}];

  console.log(aggregate_info);
  
  // button functions
  d3.selectAll("button[value=\"july_4\"]").on("click", function () {
    //if not currently selected
      //change start time, end time,
    if(this.value != current_day) {
      clearInterval(myVar);
      starting_time = new Date("2014-07-04 00:00:00");
      ending_time = new Date("2014-07-05 00:00:00");

      //change bike_data
      bike_data = july4_bikes;
      weather_data = july4_weather;
      //change weather data
      //reset function
      $("#slider").slider({
                value: starting_time.getTime(),
                min: starting_time.getTime(),
                max: ending_time.getTime(),
      });
      d3.select("svg").remove();
      var bikeline_vis = new bikeLineVis(d3.select("#bikeline"), bike_data);
      d3.selectAll("button").attr("class", 'day');
      d3.selectAll("button[value=\"july_4\"]").attr("class", 'buttonactive');
      resetbike();
      current_day = this.value;
    }
  });

   d3.selectAll("button[value=\"dec_1\"]").on("click", function () {
    //if not currently selected
      //change start time, end time,
    if(this.value != current_day) {
      clearInterval(myVar);
      starting_time = new Date("2014-12-01 00:00:00");
      ending_time = new Date("2014-12-02 00:00:00");

      bike_data = dec1_bikes;
      weather_data = december_first_data;
      //reset function
      $("#slider").slider({
                value: starting_time.getTime(),
                min: starting_time.getTime(),
                max: ending_time.getTime(),
      });
      d3.select("svg").remove();
      var bikeline_vis = new bikeLineVis(d3.select("#bikeline"), bike_data);
      d3.selectAll("button").attr("class", 'day')
      d3.selectAll("button[value=\"dec_1\"]").attr("class", 'buttonactive');
      resetbike();
      current_day = this.value;
    }
  });


  // Initialize the bar charts
  var averageDay_vis = new averageDayVis(d3.select("#barchart"), barchart_data);
  var aggregate_vis = new aggregateVis(d3.select("#aggregate_chart"), aggregate_info);

  // Update barchart data
  //barchart_data = day1;

  // Initialize the bar chart
  //var averageDay_vis = new averageDayVis(d3.select("#barchart"), full_bike_data)
  //console.log(barchart_data);
  //var average_hour_today = (bike_data.length / 24);

  // Initialize the bar chart
  //var averageDay_vis = new averageDayVis(d3.select("#barchart"), barchart_data);
  var bikeline_vis = new bikeLineVis(d3.select("#bikeline"), bike_data);

  //Format the weather
  var hour = d3.time.format("%H");
  // TODO: add in some filtering function based on day or something.
  function strip(hour) {
    if (hour > 9)
      return hour;
    else {
      return (hour/10)*10;
    }
  }
  document.getElementById("temp").innerHTML = "Temperature: " + weather_data[strip(hour(current_time))]["DryBulbFarenheit"]+ " F";

  // Format the date
  var formatDate = d3.time.format("%a, %b %e, %H:%M");
  var format_day_hour = d3.time.format("%a, %b %e, %H");

  document.getElementById("time").innerHTML = "Current Time: <br>" + formatDate(starting_time);

  // Bike Catergorize Functions
  d3.selectAll("input[name=\"filter\"]").on("click", function () {
    filter = this.value;
    svg.selectAll(".bikes")
      .style("fill", function(d) {
        return filters[filter](d);
      });
  });

  $("#slider").slider({
      value: starting_time.getTime(),
      min: starting_time.getTime(),
      max: ending_time.getTime(),
      step: 60*1000,
      slide: function() {
        update();
        update_hour_bar("manual change");
      },
      change: function() {
        update_hour_bar("slider change");
        update();

        // Also update the bar chart here
        
      }
  });

  

  function update_hour_bar(type) {

    var new_time = new Date($("#slider").slider('value'));
    var format_minute_only = d3.time.format("%M");
    var format_hour_only = d3.time.format("%H");
    var format_day = d3.time.format("%b %e");

    // Update at the start of the hour only


     if (format_minute_only(new_time) == "00" || (type == "manual change")){
       //console.log("time to update the bar chart");
       console.log(new_time);
       //console.log(format_day(new_time));
       averageDay_vis.updateVis(format_hour_only(new_time), format_day(new_time)); // actually do this.
     }
  }

  function update_aggregate_bar(time){
    //console.log("about to update hour bar");
    var format_minute_only = d3.time.format("%M");
    var format_hour_only = d3.time.format("%H");
    var format_day = d3.time.format("%b %e");
    console.log(format_day(time));
    //console.log(format_hour_only(time));
    //console.log(format_minute_only(time));
    aggregate_vis.updateVis(format_hour_only(time), format_minute_only(time), format_day(time));
  }

  function update() {
    var new_time = new Date($("#slider").slider('value'));
    update_aggregate_bar(new_time);
    document.getElementById("time").innerHTML = "Current Time: <br>" + formatDate(new_time);
    document.getElementById("temp").innerHTML = "Temperature: " + weather_data[strip(hour(current_time))]["DryBulbFarenheit"]+ " F";
    if (weather_data[strip(hour(current_time))]["WeatherType"] == "-RA") {
      document.getElementById("weathericon").innerHTML = "<img src='/img/rain.png' >";
    }
    else if (weather_data[strip(hour(current_time))]["WeatherType"] == " ") {
      document.getElementById("weathericon").innerHTML = "<img src='/img/sun.png' >";
    }

    // var format_hour = d3.time.format("%H"); 

    // //console.log(format_hour(new_time) == format_hour(current_time));

    // if (d3.time.hour.floor(new_time).getTime() != d3.time.hour.floor(current_time).getTime()) {
    //   console.log("new hour");
    //   //update_hour_bar();
    // }

    var difference = Math.abs((new_time-current_time)/(60*1000));
        if(difference > 15) {
          // remove all the bikes
          svg.selectAll(".bikes").remove();
          // make the data for all the bikes in that period
          minidata = all_bikes_for_date(new_time);
          createnewbikes(minidata);
          current_time = new_time;

        } else {
          if(new_time > current_time) {
            for(var i = 0; i < difference; i++) {
              current_time = new Date(current_time.getTime() + 60*1000);
              animate();
              minidata = new_trips(current_time, true);
              createnewbikes(minidata);
            }
          } else {
            for(var i = 0; i < difference; i++) {
              current_time = new Date(current_time.getTime() - 60*1000);
              animate_backwards();
              minidata = new_trips(current_time, false);
              createnewbikes(minidata);
            }
          }
        }
  }

  var myVar;
  // document.getElementById("#play").oninput = function() { playbyyear(); };

  // if we add to end, it'll just iterate through every minute...
  d3.select("#play").style("display", "initial").on("click", playbyyear);
  d3.select("#pause").on("click", function() {clearInterval(myVar);})
  d3.select("#reset").style("display", "initial").on("click", resetbike);

  function playbyyear() {
    var temp=0;
    myVar = setTimeout(function () {
        //$("#slider").slider('value', this.value + 1);
        var update_time = new Date(current_time.getTime() + 60*1000);
        //animate();
        //minidata = new_trips(current_time, true);
        //createnewbikes(minidata);
        //document.getElementById("time").innerHTML = "Current Time: <br>" + formatDate(current_time);
        //document.getElementById("temp").innerHTML = "Temperature: " + weather_data[strip(hour(current_time))]["DryBulbFarenheit"]+ " F";
       /* d3.select("#slider-time").attr("value", function() {
          // console.log(temp)
          // temp = this.value+1;
          // console.log(temp)
          //console.log(d3.select("#ui-slider"))
          return (this.value + 1);
        });*/
        $("#slider").slider('value', update_time);
        if(current_time < ending_time) {
          playbyyear();
        }
      }, 75) // < 0.1 second
  }

  function resetbike() {
    $("#slider").slider('value', starting_time.getTime());
    //current_time = starting_time;
    //minidata = new_trips(current_time, true);
    //createnewbikes(minidata);
    //document.getElementById("time").innerHTML = "Current Time: <br>" + formatDate(current_time);
    //reset weather
  }

  // Create a date range slider
  //var MyEventHandler = new Object();
  //var slider = new Slider(d3.select("#slider"), [], MyEventHandler);

  // Handle the event for the slider
  /*$(MyEventHandler).bind("selectionChanged", function(event, value) {
    document.getElementById("time").innerHTML = "Current Time: <br>" + formatDate(value.time);
    
    if(d3.time.minute.floor(new Date(value.time)) > d3.time.minute.floor(current_time)) {

      animate();
      current_time = new Date(value.time);
      minidata = data_for_minute(current_time);
      createnewbikes(minidata);
      // console.log(minidata)
      // console.log(current_time);
    }
  });*/



  // Build the map
  L.mapbox.accessToken = 'pk.eyJ1IjoiY2l0eWN5Y2xlIiwiYSI6IjZ3MXNtRW8ifQ.lmAxO5RTphn4Jo-QV63Vpg';
  var layer = L.mapbox.tileLayer('citycycle.lnkh0jpk');
  var map = L.map('map')
      .addLayer(layer)
      .setView([40.72332345541449, -73.99], 13);

  var svg = d3.select(map.getPanes().overlayPane).append("svg");
  var g = svg.append("g").attr("class", "leaflet-zoom-hide");

  // returns all the trips for that minute, use a while loop with a condition so we don't go needlessly into the data
  function new_trips(date, time_direction_forward) {
    var bike_list_minute = [];
    var i = 0; 
    if (time_direction_forward) {
      while (i < bike_data.length && new Date(bike_data[i].starttime) < d3.time.minute.floor(d3.time.minute.offset(date,1))) {
        var bike_start_time = d3.time.minute.floor(new Date(bike_data[i].starttime));
        if(bike_start_time.getTime() == d3.time.minute.floor(date).getTime()) {

          var bikes_data = bike_data[i];
          var bike_stop_time = d3.time.minute.floor(new Date(bike_data[i].stoptime));
          bikes_data.time_line = time_line(bikes_data, bike_stop_time, bike_start_time);
          bikes_data.minute = 0;  
          bike_list_minute.push(bikes_data);
        }
        i++;
      }
    }
    else {
      while (i < bike_data.length) {
        var bike_stop_time = d3.time.minute.floor(new Date(bike_data[i].stoptime));

        if(bike_stop_time.getTime() == d3.time.minute.floor(date).getTime()) { 

          var bikes_data = bike_data[i];
          var bike_start_time = d3.time.minute.floor(new Date(bike_data[i].starttime));
          bikes_data.time_line = time_line(bikes_data, bike_stop_time, bike_start_time);
          bikes_data.minute = bikes_data.time_line.length-1;  
          bike_list_minute.push(bikes_data);
        }
        i++;
      }
    }
    return bike_list_minute;
  }

  function time_line (bikes_data, bike_stop_time, bike_start_time) {
    var range = bike_stop_time - bike_start_time;
    range = range/(1000*60);

    var start_long = parseFloat(bikes_data["start station longitude"])
    var start_lat = parseFloat(bikes_data["start station latitude"])
    var end_long = parseFloat(bikes_data["end station longitude"])
    var end_lat = parseFloat(bikes_data["end station latitude"])

    var longitude_step = (end_long - start_long)/range;
    var latitude_step = (end_lat - start_lat)/range;

    return d3.range(0,range+1).map(function(d,i) {
      return {time:new Date(bike_start_time.getTime() + i*(1000*60)), longitude:start_long + (i)*longitude_step, latitude:start_lat + (i)*latitude_step};
    });
  }


  function all_bikes_for_date(date) {
    var bike_list_minute = [];
    var date_rounded = d3.time.minute.floor(date);
    var i = 0; 
    while (i < bike_data.length) {
      var bike_start_time = d3.time.minute.floor(new Date(bike_data[i].starttime));
      var bike_stop_time = d3.time.minute.floor(new Date(bike_data[i].stoptime));
      if(date_rounded.getTime() == bike_stop_time.getTime() || date_rounded.getTime() == bike_start_time.getTime() || (date_rounded < bike_stop_time && date_rounded > bike_start_time)) 
      {
        var bikes_data = bike_data[i];
        bikes_data.time_line = time_line(bikes_data, bike_stop_time, bike_start_time);
        bikes_data.minute = bikes_data.time_line.map(function(d,i) {return d.time.getTime();}).indexOf(date_rounded.getTime());  
        bike_list_minute.push(bikes_data);
      }
      i++;
    }
    return bike_list_minute;
  }

  function createnewbikes (minidata) {
      var bikes = g.selectAll("bikes")
          .data(minidata)
          .enter()
          .append("circle")
            .style("fill", function(d) {
              return filters[filter](d);
             })
            .attr("r", 2)
            .attr("class", "bikes")
            .attr("transform",
                    function(d) { 
                        new_coordinates = applyLatLngToLayer(d.time_line[d.minute]);

                        // make the circle station a darker oppacity keep for a few secs then remove
                        if(d.minute == 0) {
                            emit(new_coordinates);
                        }
                        return "translate(" +
                             new_coordinates.x + "," +
                             new_coordinates.y + ")";
                    })
  }

  var stations = g.selectAll("stations")
            .data(stationsList)
            .enter()
            .append("circle")
            .attr("r", 4)
            .attr("class", "stations");


  var minidata = all_bikes_for_date(current_time);
  createnewbikes(minidata);
  reset();

  function applyLatLngToLayer(d) {
      var y = d.latitude;
      var x = d.longitude;
    return map.latLngToLayerPoint(new L.LatLng(y, x))
  }

  function reset() {
    var x_coors = [];
    var y_coors = [];

    stations.attr("transform",
                  function(d) {
                      var x = applyLatLngToLayer(d).x;
                      var y = applyLatLngToLayer(d).y;

                      x_coors.push(x);
                      y_coors.push(y);

                      return "translate(" +
                          x + "," +
                          y + ")";
                  });

    svg.selectAll(".bikes")
      .attr("transform",
                    function(d) { 
                        new_coordinates = applyLatLngToLayer(d.time_line[d.minute]);
                        return "translate(" +
                             new_coordinates.x + "," +
                             new_coordinates.y + ")";
                    });

    var topLeft = [d3.min(x_coors), d3.min(y_coors)];
    var bottomRight = [d3.max(x_coors), d3.max(y_coors)];

    svg.attr("width", bottomRight[0] - topLeft[0] + 120)
                .attr("height", bottomRight[1] - topLeft[1] + 120)
                .style("left", topLeft[0] - 50 + "px")
                .style("top", topLeft[1] - 50 + "px");

    g.attr("transform", "translate(" + (-topLeft[0] + 50) + "," + (-topLeft[1] + 50) + ")");
  }

  function emit(coordinates) {
      var emit = g.append("circle")
        .attr("r", 5)
        .style("fill", "steelblue")
        .attr("class", "hi")
        .style("opacity", 0)
        .attr("transform", function() { 
          return "translate(" +
            coordinates.x + "," +
            coordinates.y + ")";
      })
        .transition()
            .duration(100)
            .style("opacity", .4)
            .transition()
              .duration(100)
              .style("opacity", 0)
              .remove()
  }

  function animate() {
   
    svg.selectAll(".bikes")
      .transition()
        .attr("transform",
                      function(d) {
                          d.minute++;
                          if(d.minute >= d.time_line.length) {
                            this.remove();
                            return;
                          }

                          new_coordinates = applyLatLngToLayer(d.time_line[d.minute]);
                          return "translate(" +
                               new_coordinates.x + "," +
                               new_coordinates.y + ")";
                      }); 
  }

  function animate_backwards() {
    svg.selectAll(".bikes")
      .transition()
        .attr("transform",
                      function(d) {
                          d.minute--;
                          if(d.minute == -1) {
                            emit_coordinates = applyLatLngToLayer(d.time_line[0]);
                            emit(emit_coordinates);
                            this.remove();
                            return;
                          }
                          new_coordinates = applyLatLngToLayer(d.time_line[d.minute]);
                          return "translate(" +
                               new_coordinates.x + "," +
                               new_coordinates.y + ")";
                      });
  }
  map.on("viewreset", reset);
}
    </script>
  </body>
</html>
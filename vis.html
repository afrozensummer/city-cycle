<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
    <script src="http://d3js.org/d3.v3.js" charset="utf-8"></script>
    <script src="libs/jquery.min.js" charset="utf-8"></script>
    <script src="js/slider.js"></script>
    <link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.8/mapbox.css' rel='stylesheet' />
    <script src="http://cdn.leafletjs.com/leaflet-0.7/leaflet.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.8/mapbox.js'></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    
    <link href='http://fonts.googleapis.com/css?family=Raleway|Poiret+One' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <style type="text/css">

html, body {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
}
.slider
{
    display: none;
    width: 1000px;
}

.bikes, .stations, .bikes svg, .stations svg {
  position: absolute;
}

.bikes, .stations svg {
  width: 60px;
  height: 20px;
  padding-right: 100px;
  font: 10px sans-serif;
}

.stations {
  fill: steelblue;
  opacity: 0.3;
/*  stroke: black;
  stroke-width: .8px;*/
}

.bikes {
  z-index: 1;
  opacity: 1;
} 

    </style>
  </head>
  <body class = "viscontainer"> 
    <div class = "header">
      CitiBike Visualization
    </div>
    <div>
      Lorem ipsum dolor sit amet, consectetur adipisicing elit. Voluptatem aspernatur facilis ipsum, beatae! Quasi amet ratione perspiciatis velit, excepturi nisi. Magni repellat amet illum ducimus cum. Saepe harum repellendus perspiciatis. <br><br>
    </div>

    <div id = "new slider"><input type="image" src="img/play.png" name="play" id="play" />
    <input type="range" name="minutes" min="0" max="0" step="1" value="0" class="slider"id="slider-time"; ></div>
    <div id="slider"></div>      
    <div id = "description_container">
      <div id = "time"></div>
      <br>
      <div id = "temp"></div>  </div><!-- <div id="map_cover"></div> -->
      <div id = "bike categorize"> 
        Categorize By:
        <label><input type="radio" name="filter" value="none" checked> None </label>
        <label><input type="radio" name="filter" value="gender"> Gender </label>  
        <label><input type="radio" name="filter" value="subscription"> Subscription </label>
      </div>
      <div id="legend"></div> 
      <div id="map"></div>
      

     
    <script type="text/javascript">

// Variables
var bike_data;
var station_data;
var starting_time = new Date("2014-12-01 00:00:00"); 
var ending_time = new Date("2014-12-02 00:00:00");
var current_time = starting_time;
var filter = "none";
var filters = {
    none: function(d) {return "#000"},
    gender: function(d) { 
      if(d.gender == 1) return "#0000ff";
      if(d.gender == 2) return "#FF0000";
      return "#8A2BE2";
    },
    subscription: function(d) { 
      if(d.usertype == "Customer") return "#0080ff";
      return "#ffa500";
    }
  };

queue()
  .defer(d3.json, "data/stations.json") 
  .defer(d3.csv, "data/december2014.csv")
  .defer(d3.csv, "data/weatherdata.csv")
    .await(function(error, stations, bikes, weather) { 
        // error handling
        station_data = stations;
        full_bike_data = bikes;
        weather_data = weather;
        data_loaded();

  });

function data_loaded() {
  // Edit data
  var stationsList = station_data["stationBeanList"];
  var j =0, bike_data=[];
  while(new Date(full_bike_data[j].starttime) < d3.time.minute.floor(d3.time.minute.offset(ending_time,1))) {
    bike_data.push(full_bike_data[j]);
    j++;
  }

  // Format the weather
  document.getElementById("temp").innerHTML = "Temperature: " + weather_data[0]["TMAX"];

  // Format the date
  var formatDate = d3.time.format("%a, %b %e, %H:%M");
  document.getElementById("time").innerHTML = "Current Time: <br>" + formatDate(starting_time);

  // Bike Catergorize Functions
  d3.selectAll("input[name=\"filter\"]").on("click", function () {
    filter = this.value;
    svg.selectAll(".bikes")
      .style("fill", function(d) {
        return filters[filter](d);
      });
  });

  // Make the silder
  function make_slider() {
    // update max value
    var total_minutes = (d3.time.minute.floor(ending_time) - d3.time.minute.floor(starting_time))/(1000*60);
    d3.select("#slider-time")
      .attr("max", total_minutes)
      .style("display", "initial")
      .on("input", function() {
        var new_time = new Date(this.value*60*1000 + starting_time.getTime());
        document.getElementById("time").innerHTML = "Current Time: <br>" + formatDate(new_time);
        var difference = Math.abs((new_time-current_time)/(60*1000));

        if(difference > 15) {
          // remove all the bikes
          svg.selectAll(".bikes").remove();
          // make the data for all the bikes in that period
          minidata = all_bikes_for_date(new_time);
          createnewbikes(minidata);
          current_time = new_time;
        } else {
          if(new_time > current_time) {
            for(var i = 0; i < difference; i++) {
              current_time = new Date(current_time.getTime() + 60*1000);
              animate();
              minidata = new_trips(current_time, true);
              createnewbikes(minidata);
            }
          } else {
            for(var i = 0; i < difference; i++) {
              current_time = new Date(current_time.getTime() - 60*1000);
              animate_backwards();
              minidata = new_trips(current_time, false);
              createnewbikes(minidata);
            }
          }
        }      
      });
  }
  make_slider();

  d3.select("#play")
      .on("input", function() {
        console.log("hi")
        //console.log(current_time.getTime())
        while (current_time <= ending_time) {
          //$("#play").delay("slow");
          current_time = new Date(current_time.getTime() + 60*1000);
          console.log(current_time);
          $("#play").delay("slow").animate();
          minidata = new_trips(current_time, forward);
          createnewbikes(minidata);
        }


        
        //d3.select("#slider-time")
      });

  // Create a date range slider
  //var MyEventHandler = new Object();
  //var slider = new Slider(d3.select("#slider"), [], MyEventHandler);

  // Handle the event for the slider
  /*$(MyEventHandler).bind("selectionChanged", function(event, value) {
    document.getElementById("time").innerHTML = "Current Time: <br>" + formatDate(value.time);
    
    if(d3.time.minute.floor(new Date(value.time)) > d3.time.minute.floor(current_time)) {

      animate();
      current_time = new Date(value.time);
      minidata = data_for_minute(current_time);
      createnewbikes(minidata);
      // console.log(minidata)
      // console.log(current_time);
    }
  });*/

  // Build the map
  L.mapbox.accessToken = 'pk.eyJ1IjoiY2l0eWN5Y2xlIiwiYSI6IjZ3MXNtRW8ifQ.lmAxO5RTphn4Jo-QV63Vpg';
  var layer = L.mapbox.tileLayer('citycycle.lnkh0jpk');
  var map = L.map('map')
      .addLayer(layer)
      .setView([40.72332345541449, -73.99], 12);

  var svg = d3.select(map.getPanes().overlayPane).append("svg");
  var g = svg.append("g").attr("class", "leaflet-zoom-hide");

  // returns all the trips for that minute, use a while loop with a condition so we don't go needlessly into the data
  function new_trips(date, time_direction_forward) {
    var bike_list_minute = [];
    var i = 0; 
    if (time_direction_forward) {
      while (i < bike_data.length && new Date(bike_data[i].starttime) < d3.time.minute.floor(d3.time.minute.offset(date,1))) {
        var bike_start_time = d3.time.minute.floor(new Date(bike_data[i].starttime));
        if(bike_start_time.getTime() == d3.time.minute.floor(date).getTime()) {

          var bikes_data = bike_data[i];
          var bike_stop_time = d3.time.minute.floor(new Date(bike_data[i].stoptime));
          bikes_data.time_line = time_line(bikes_data, bike_stop_time, bike_start_time);
          bikes_data.minute = 0;  
          bike_list_minute.push(bikes_data);
        }
        i++;
      }
    }
    else {
      while (i < bike_data.length) {
        var bike_stop_time = d3.time.minute.floor(new Date(bike_data[i].stoptime));

        if(bike_stop_time.getTime() == d3.time.minute.floor(date).getTime()) { 

          var bikes_data = bike_data[i];
          var bike_start_time = d3.time.minute.floor(new Date(bike_data[i].starttime));
          bikes_data.time_line = time_line(bikes_data, bike_stop_time, bike_start_time);
          bikes_data.minute = bikes_data.time_line.length-1;  
          bike_list_minute.push(bikes_data);
        }
        i++;
      }
    }
    return bike_list_minute;
  }

  function time_line (bikes_data, bike_stop_time, bike_start_time) {
    var range = bike_stop_time - bike_start_time;
    range = range/(1000*60);

    var start_long = parseFloat(bikes_data["start station longitude"])
    var start_lat = parseFloat(bikes_data["start station latitude"])
    var end_long = parseFloat(bikes_data["end station longitude"])
    var end_lat = parseFloat(bikes_data["end station latitude"])

    var longitude_step = (end_long - start_long)/range;
    var latitude_step = (end_lat - start_lat)/range;

    return d3.range(0,range+1).map(function(d,i) {
      return {time:new Date(bike_start_time.getTime() + i*(1000*60)), longitude:start_long + (i)*longitude_step, latitude:start_lat + (i)*latitude_step};
    });
  }


  function all_bikes_for_date(date) {
    var bike_list_minute = [];
    var date_rounded = d3.time.minute.floor(date);
    var i = 0; 
    while (i < bike_data.length) {
      var bike_start_time = d3.time.minute.floor(new Date(bike_data[i].starttime));
      var bike_stop_time = d3.time.minute.floor(new Date(bike_data[i].stoptime));
      if(date_rounded.getTime() == bike_stop_time.getTime() || date_rounded.getTime() == bike_start_time.getTime() || (date_rounded < bike_stop_time && date_rounded > bike_start_time)) 
      {
        var bikes_data = bike_data[i];
        bikes_data.time_line = time_line(bikes_data, bike_stop_time, bike_start_time);
        bikes_data.minute = bikes_data.time_line.map(function(d,i) {return d.time.getTime();}).indexOf(date_rounded.getTime());  
        bike_list_minute.push(bikes_data);
      }
      i++;
    }
    return bike_list_minute;
  }

  function createnewbikes (minidata) {
      var bikes = g.selectAll("bikes")
          .data(minidata)
          .enter()
          .append("circle")
            .style("fill", function(d) {
              return filters[filter](d);
             })
            .attr("r", 3)
            .attr("class", "bikes")
            .attr("transform",
                    function(d) { 
                        new_coordinates = applyLatLngToLayer(d.time_line[d.minute]);
                        return "translate(" +
                             new_coordinates.x + "," +
                             new_coordinates.y + ")";
                    })
      // make the circle station a darker oppacity keep for a few secs then remove
  }

  var stations = g.selectAll("stations")
            .data(stationsList)
            .enter()
            .append("circle")
            .attr("r", 3)
            .attr("class", "stations");


  var minidata = all_bikes_for_date(current_time);
  createnewbikes(minidata);
  reset();

  function applyLatLngToLayer(d) {
      var y = d.latitude;
      var x = d.longitude;
    return map.latLngToLayerPoint(new L.LatLng(y, x))
  }

  function reset() {
    var x_coors = [];
    var y_coors = [];

    stations.attr("transform",
                  function(d) {
                      var x = applyLatLngToLayer(d).x;
                      var y = applyLatLngToLayer(d).y;

                      x_coors.push(x);
                      y_coors.push(y);

                      return "translate(" +
                          x + "," +
                          y + ")";
                  });

    svg.selectAll(".bikes")
      .attr("transform",
                    function(d) { 
                        new_coordinates = applyLatLngToLayer(d.time_line[d.minute]);
                        return "translate(" +
                             new_coordinates.x + "," +
                             new_coordinates.y + ")";
                    });

    var topLeft = [d3.min(x_coors), d3.min(y_coors)];
    var bottomRight = [d3.max(x_coors), d3.max(y_coors)];

    svg.attr("width", bottomRight[0] - topLeft[0] + 120)
                .attr("height", bottomRight[1] - topLeft[1] + 120)
                .style("left", topLeft[0] - 50 + "px")
                .style("top", topLeft[1] - 50 + "px");

    g.attr("transform", "translate(" + (-topLeft[0] + 50) + "," + (-topLeft[1] + 50) + ")");
  }

  function animate() {
   
    svg.selectAll(".bikes")
      .transition()
        .attr("transform",
                      function(d) {
                          d.minute++;
                          if(d.minute >= d.time_line.length) {
                            this.remove();
                            return;
                          }

                          new_coordinates = applyLatLngToLayer(d.time_line[d.minute]);
                          return "translate(" +
                               new_coordinates.x + "," +
                               new_coordinates.y + ")";
                      }); 
  }

  function animate_backwards() {
    svg.selectAll(".bikes")
      .transition()
        .attr("transform",
                      function(d) {
                          d.minute--;
                          if(d.minute == 0) {
                            // make the circle station a darker oppacity keep for a few secs then remove
                          }
                          if(d.minute < 0) {
                            this.remove();
                            d.minute = -1;
                            return;
                          }
                          new_coordinates = applyLatLngToLayer(d.time_line[d.minute]);
                          return "translate(" +
                               new_coordinates.x + "," +
                               new_coordinates.y + ")";
                      });
  }
  map.on("viewreset", reset);
}
    </script>
  </body>
</html>